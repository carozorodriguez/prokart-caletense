<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ficha del Piloto | PROKART CALETENSE</title>

<!-- ===============================
     ESTILOS GENERALES
================================ -->
<style>
:root { --rojo:#e10600; --negro:#111; --gris:#f4f4f4; }
*{box-sizing:border-box}
body{margin:0;font-family:Arial,sans-serif;background:var(--gris)}
header{background:#111;color:#fff;padding:40px 20px;text-align:center}
section{max-width:1000px;margin:auto;padding:40px 20px}

/* ===============================
   BLOQUE PILOTO
================================ */
.piloto{display:grid;grid-template-columns:220px 1fr;gap:30px;background:#fff;padding:30px;border-radius:12px}
.piloto img.foto{width:220px;height:220px;border-radius:50%;object-fit:cover}

/* ===============================
   QR
================================ */
.qr{text-align:center;margin-top:15px}
.qr img{width:120px}

/* ===============================
   TABLAS
================================ */
table{width:100%;border-collapse:collapse;margin-top:30px}
th,td{padding:12px;border-bottom:1px solid #ddd}
th{background:#111;color:#fff}
</style>
</head>

<body>

<!-- ===============================
     HEADER
================================ -->
<header>
  <h1 id="nombrePiloto"></h1>
  <p id="categoriaPiloto"></p>
</header>

<!-- ===============================
     CONTENIDO PRINCIPAL
================================ -->
<section>

  <!-- ===== BLOQUE DATOS PILOTO ===== -->
  <div class="piloto">

    <!-- FOTO + QR -->
    <div>
      <img id="fotoPiloto" class="foto" alt="Foto Piloto">
      <div class="qr">
        <img id="qrPiloto" alt="QR Piloto">
        <p>Escanear ficha</p>
      </div>
    </div>

    <!-- RESUMEN -->
    <div>
      <h2>Resumen Deportivo</h2>
      <p><strong>Puntos Totales:</strong> <span id="totalPuntos">0</span></p>
      <p><strong>Mejor Resultado:</strong> <span id="mejorResultado">-</span></p>
      <p><strong>Cantidad de Fechas:</strong> <span id="cantidadFechas">0</span></p>
    </div>

  </div>

  <!-- ===== HISTORIAL ===== -->
  <h2>Historial por Fecha</h2>
  <table>
    <thead>
      <tr><th>Fecha</th><th>Puesto</th><th>Puntos</th></tr>
    </thead>
    <tbody id="historial"></tbody>
  </table>

</section>

<!-- ===============================
     SCRIPT
================================ -->
<script>
/* =========================================================
   1️⃣ CONFIGURACIÓN DE CATEGORÍAS (EDITÁS SOLO ESTO)
========================================================= */
const CATEGORIAS={
  "PRE JUNIOR":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQFypnuhKrIq3bwVhehER3JFHbPukGhNGqrAqC2avomKgLPdu6C069biQFU5lAcJ3_6kt7Jntl4dre0/pub?gid=0&single=true&output=csv",
  "JUNIOR":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQFypnuhKrIq3bwVhehER3JFHbPukGhNGqrAqC2avomKgLPdu6C069biQFU5lAcJ3_6kt7Jntl4dre0/pub?gid=1173158505&single=true&output=csv",
  "110 Cajeros":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQFypnuhKrIq3bwVhehER3JFHbPukGhNGqrAqC2avomKgLPdu6C069biQFU5lAcJ3_6kt7Jntl4dre0/pub?gid=796482582&single=true&output=csv",
  "200 Master":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQFypnuhKrIq3bwVhehER3JFHbPukGhNGqrAqC2avomKgLPdu6C069biQFU5lAcJ3_6kt7Jntl4dre0/pub?gid=2021979125&single=true&output=csv",
  "200 STD":"https://docs.google.com/spreadsheets/d/e/2PACX-1vQFypnuhKrIq3bwVhehER3JFHbPukGhNGqrAqC2avomKgLPdu6C069biQFU5lAcJ3_6kt7Jntl4dre0/pub?gid=660182728&single=true&output=csv"
};

/* =========================================================
   2️⃣ PARÁMETROS URL
========================================================= */
const params=new URLSearchParams(window.location.search);
const piloto=params.get('piloto');
const categoria=params.get('categoria');

if(!piloto||!categoria||!CATEGORIAS[categoria]){
  alert('Ficha de piloto inválida');
  throw new Error('Parámetros inválidos');
}

/* =========================================================
   3️⃣ UI BÁSICA
========================================================= */
document.getElementById('nombrePiloto').textContent=piloto;
document.getElementById('categoriaPiloto').textContent=categoria;

const foto=document.getElementById('fotoPiloto');
foto.src=`pilotos/${piloto.replaceAll(' ','_')}.jpg`;
foto.onerror=()=>foto.src='pilotos/default.jpg';

const urlFicha=window.location.href;
document.getElementById('qrPiloto').src=
  `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(urlFicha)}`;

/* =========================================================
   4️⃣ CARGA DE DATOS
========================================================= */
fetch(CATEGORIAS[categoria])
  .then(r=>r.text())
  .then(text=>procesarCSV(text))
  .catch(()=>alert('Error cargando datos del piloto'));

/* =========================================================
   5️⃣ PROCESAMIENTO
========================================================= */
function procesarCSV(text){
  const filas=text.trim().split('\n').slice(1);
  const datos=filas.map(f=>{
    const c=f.split(',').map(v=>v.replace(/"/g,'').trim());
    return {fecha:c[0],piloto:c[1],puesto:+c[2],puntos:+c[3]};
  }).filter(d=>d.piloto===piloto);

  let total=0;let mejor=999;
  const body=document.getElementById('historial');
  body.innerHTML='';

  datos.forEach(d=>{
    total+=d.puntos;
    if(d.puesto>0&&d.puesto<mejor)mejor=d.puesto;
    body.innerHTML+=`<tr><td>${d.fecha}</td><td>${d.puesto}</td><td>${d.puntos}</td></tr>`;
  });

  document.getElementById('totalPuntos').textContent=total;
  document.getElementById('mejorResultado').textContent=mejor===999?'-':mejor;
  document.getElementById('cantidadFechas').textContent=datos.length;
}
</script>

</body>
</html>
